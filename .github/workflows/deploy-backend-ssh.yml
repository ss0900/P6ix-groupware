name: Deploy Backend via SSH

on:
  push:
    branches:
      - main
    paths:
      - backend/**
      - .github/workflows/deploy-backend-ssh.yml
  workflow_dispatch:
    inputs:
      branch:
        description: Branch to deploy
        required: true
        default: main
      run_migrate:
        description: Run Django migrate
        type: boolean
        required: true
        default: true
      run_collectstatic:
        description: Run Django collectstatic
        type: boolean
        required: true
        default: false

permissions:
  contents: read

concurrency:
  group: backend-production
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      APP_DIR: ${{ vars.BACKEND_APP_DIR || '/var/www/P6ix-groupware' }}
      VENV_PATH: ${{ vars.BACKEND_VENV_PATH || '.venv' }}
      DEPLOY_BRANCH: ${{ github.event.inputs.branch || github.ref_name }}
      RUN_MIGRATE: ${{ github.event.inputs.run_migrate || 'true' }}
      RUN_COLLECTSTATIC: ${{ github.event.inputs.run_collectstatic || vars.BACKEND_RUN_COLLECTSTATIC || 'false' }}
      RESTART_COMMAND: ${{ vars.BACKEND_RESTART_COMMAND || '' }}
      POST_DEPLOY_COMMAND: ${{ vars.BACKEND_POST_DEPLOY_COMMAND || '' }}
    steps:
      - name: Validate required secrets
        env:
          BACKEND_SSH_HOST: ${{ secrets.BACKEND_SSH_HOST }}
          BACKEND_SSH_USER: ${{ secrets.BACKEND_SSH_USER }}
          BACKEND_SSH_KEY: ${{ secrets.BACKEND_SSH_KEY }}
        run: |
          test -n "$BACKEND_SSH_HOST" || (echo "Missing secret: BACKEND_SSH_HOST" && exit 1)
          test -n "$BACKEND_SSH_USER" || (echo "Missing secret: BACKEND_SSH_USER" && exit 1)
          test -n "$BACKEND_SSH_KEY" || (echo "Missing secret: BACKEND_SSH_KEY" && exit 1)

      - name: Deploy on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.BACKEND_SSH_HOST }}
          username: ${{ secrets.BACKEND_SSH_USER }}
          key: ${{ secrets.BACKEND_SSH_KEY }}
          port: ${{ secrets.BACKEND_SSH_PORT || '22' }}
          script_stop: true
          envs: APP_DIR,VENV_PATH,DEPLOY_BRANCH,RUN_MIGRATE,RUN_COLLECTSTATIC,RESTART_COMMAND,POST_DEPLOY_COMMAND
          script: |
            set -euo pipefail

            cd "$APP_DIR"
            git fetch origin "$DEPLOY_BRANCH"
            git checkout "$DEPLOY_BRANCH"
            git pull --ff-only origin "$DEPLOY_BRANCH"

            if [ -f "$VENV_PATH/bin/activate" ]; then
              . "$VENV_PATH/bin/activate"
            elif [ -f "$VENV_PATH/Scripts/activate" ]; then
              . "$VENV_PATH/Scripts/activate"
            else
              echo "Virtualenv activation script not found: $VENV_PATH"
              exit 1
            fi

            python -m pip install --upgrade pip
            pip install -r backend/requirements.txt

            if [ "$RUN_MIGRATE" = "true" ]; then
              python backend/manage.py migrate --noinput
            fi

            if [ "$RUN_COLLECTSTATIC" = "true" ]; then
              python backend/manage.py collectstatic --noinput
            fi

            if [ -n "$RESTART_COMMAND" ]; then
              eval "$RESTART_COMMAND"
            fi

            if [ -n "$POST_DEPLOY_COMMAND" ]; then
              eval "$POST_DEPLOY_COMMAND"
            fi
